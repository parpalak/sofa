#include <stdio.h>
#include <stdlib.h>
#include <math.h>

#define PI 3.1415926535897932384626
#define PARAM 2

double delta=0.001;

int n = 10000;
int m = 10000;
double *up, *down;
double a[PARAM];

double integral () {
	double alpha, x1, y1, x2, y2, tmp, tg, ctg, shift, mult;
	int i, j, k;

	double len;
//	len = 2 + 2 * (a[0] + a[1] + a[8] + a[9] + a[10] + a[11]);

	for (i = m+1; i--; ) {
		up[i] = 1;
		down[i] = 0;
	}
	
	len = 0;
	for (j = 0; j < PARAM/2; j++) {
		len += a[2*j];
	}
	
	len = 2 + 2 * len;

	for (i = 1; i < n; i++) {
		alpha = PI*(double)i/n*0.5;// + PI/n*0.25;
		tg = tan(alpha);
		ctg = -1/tg;
//		x1 = a[0]*cos(2*alpha) + a[1]*cos(6*alpha) + a[8]*cos(10*alpha) + a[9]*cos(14*alpha) + a[10]*cos(18*alpha) + a[11]*cos(22*alpha);  // + alpha*a[]
//		y1 = a[2]*sin(2*alpha) + a[3]*sin(6*alpha) + a[4]*sin(10*alpha) + a[5]*sin(14*alpha) + a[6]*sin(18*alpha) + a[7]*sin(22*alpha);
		x1 = a[0]*cos(2*alpha);
		y1 = a[0]*sin(2*alpha);
/*		for (j = 0; j < PARAM/2; j++) {
		    x1 += a[2*j]*cos (alpha*2*(2*j+1));
		    y1 += a[2*j + 1]*sin (alpha*2*(2*j+1));
		}*/
		x2 = x1 + sqrt(2) * cos(PI/4 + alpha);
		y2 = y1 + sqrt(2) * sin(PI/4 + alpha);

		// Upper curve
		k = (int)((x2 / len + 0.5) * m);
		mult = tg * len/m;
		shift = y2 - tg * (x2 + len * 0.5);
		tmp = shift;
		for (j = 0; j < k; j++) {
//			tmp = shift + mult * (double)j ;
			if (up[j] > tmp)
				up[j] = tmp;
			tmp += mult;
		}
		mult = ctg * len/m;
		shift = y2 - ctg * (x2 + len * 0.5);
		tmp = shift + mult * (k+1);
		for (j = k+1; j < m+1; j++) {
//			tmp = shift + mult * (double)j ;
			if (up[j] > tmp)
				up[j] = tmp;
			tmp += mult;
		}

		// Lower curve
		k = (int)((x1 / len + 0.5) * m);
		mult = tg * len/m;
		shift = y1 - tg * (x1 + len * 0.5);
		tmp = shift;// + mult * (double)j ;
		for (j = 0; j < k; j++) {
			if (down[j] < tmp)
				down[j] = tmp;
			tmp += mult;
		}
		mult = ctg * len/m;
		shift = y1 - ctg * (x1 + len * 0.5);
		tmp = shift + mult * (k+1);
		for (j = k+1; j < m+1; j++) {
//			tmp = shift + mult * (double)j ;
			if (down[j] < tmp)
				down[j] = tmp;
			tmp += mult;
		}
	}

	// Integriren
	tmp = 0;
	for (j = 1; j < m; j+=2) {
//		printf("j=%d\n", j);
		if (up[j] >= down[j]) {
			tmp += 4*(up[j] - down[j]);
		}
		if (up[j+1] >= down[j+1]) {
			tmp += 2*(up[j+1] - down[j+1]);
		}
	}
	if (up[0] >= down[0]) {
		tmp += (up[0] - down[0]);
	}
	if (up[m] >= down[m]) {
		tmp -= (up[m] - down[m]);
	}
	return tmp/m*len/3;
}

double integral1() {
	return sin(a[0]);//- (a[0] - 2) * (a[0] - 2) - (a[0] - 4)*(a[0] - 4);
}

void maximize () {
	double grad[PARAM], comp, scal, f, f1 = 1, f2 = 0, q = 0.5, fff;
	int i;

	f = integral();
	f1 = f-0.1;
	f2 = f-0.2;
	scal = 1;
	while (/*n*n*fabs(f-f1) > 0.01*(1-q)*/scal*n*n > -0.01) {

	//	scal = 0;
		for (i = 0; i < PARAM; i++) {
			a[i] += 1.0e-9;
			fff = integral();
			comp = (fff - f) * 1.0e9;
	//		scal += comp*grad[i];
			grad[i] = comp;
//			printf("i=%d; int = %f; grad = %f; \n", i, fff, grad[i]);
			a[i] -= 1.0e-9;
		}
		scal = 0;
		for (i = 0; i < PARAM; i++) {
			a[i] += delta*grad[i];
			scal += delta*grad[i]*delta*grad[i];
			printf("a[%i] = %5.80f;\n", i, a[i]);
		}
		f2 = f1;
		f1 = f;
		f = integral();
		q = (f-f1)/(f1-f2);
		printf("-------------->>> int = %5.10f; q=%f\n", f, q);
		if (q < 0.5) q = 0.5;
 	}

}

int main() {

/*	a[0] = 0.602249;
	a[1] = 0.004820;
	a[2] = 0.664509;// 0.63661977236758;
	a[3] = 0.006013;
	a[4] = 0.001659;
	a[5] = 0.000422;
	a[6] = 0.000249;
	a[7] = 0.000058;
	a[8] = 0.001329;
	a[9] = 0.000630;
*/
a[0] = 0.60232410931196911363372237246949225664138793945312500000000000000000000000000000;
/*a[1] = 0.66492529928521126869611634901957586407661437988281250000000000000000000000000000;
a[2] = 0.00501101142231514563862848632425084360875189304351806640625000000000000000000000;
a[3] = 0.00588647110343982604002688319155822682660073041915893554687500000000000000000000;
a[4] = 0.00170422785178545358429624823060066773905418813228607177734375000000000000000000;
a[5] = 0.00176842187701479265811432828314764265087433159351348876953125000000000000000000;
a[6] = 0.00075047220417299444986808376611975290870759636163711547851562500000000000000000;
a[7] = 0.00044696608861735084633134973408630230551352724432945251464843750000000000000000;
a[8] = 0.00041890673254529891969891175484974610299104824662208557128906250000000000000000;
a[9] = 0.00028905603525181198642374225116213892761152237653732299804687500000000000000000;
a[10] = 0.00029036933972159673089663556311279535293579101562500000000000000000000000000000;
a[11] = 0.00012478991932584921221299767424284254957456141710281372070312500000000000000000;
a[12] = 0.00017227114514950514490010391455143690109252929687500000000000000000000000000000;
a[13] = 0.00008703274841392881521536656341808679826499428600072860717773437500000000000000;
a[14] = 0.00013028575040063827827907516621053218841552734375000000000000000000000000000000;
a[15] = 0.00005368305416197927115717902779579162597656250000000000000000000000000000000000;
a[16] = 0.00008393711985998918189474243822800758607627358287572860717773437500000000000000;
a[17] = 0.00003141406773599086932335922028869390487670898437500000000000000000000000000000;
a[18] = 0.00006868629850176331851693140029269102342368569225072860717773437500000000000000;
a[19] = 0.00002962587513888336959526868807923705162465921603143215179443359375000000000000;
a[20] = 0.00004518909339079613118883571587502956390380859375000000000000000000000000000000;
a[21] = 0.00001216173684737142765457506426995948345393117051571607589721679687500000000000;
a[22] = 0.00004387762739810341372503899037837982177734375000000000000000000000000000000000;
a[23] = 0.00001557025921794518924317317354333312096059671603143215179443359375000000000000;
a[24] = 0.00002965944991251134526893083742660195412099710665643215179443359375000000000000;
a[25] = 0.00000609763444003874441237244424796060116022999864071607589721679687500000000000;
a[26] = 0.00002624149470609182799307745881378650665283203125000000000000000000000000000000;
a[27] = 0.00000594576452206396766086982097476720809936523437500000000000000000000000000000;
a[28] = 0.00002424125423772238718811422586441040039062500000000000000000000000000000000000;
a[29] = 0.00000288723334618268268059182446449995040893554687500000000000000000000000000000;
a[30] = 0.00001731032141405464130912150721997022628784179687500000000000000000000000000000;
a[31] = 0.00000411358715712850653289933688938617706298828125000000000000000000000000000000;
a[32] = 0.00000047769184963186717141070403158664703369140625000000000000000000000000000000;
a[33] = 0.00000099049334512102404914912767708301544189453125000000000000000000000000000000;
a[34] = 0.00000000880236772360376562573947012424468994140625000000000000000000000000000000;
a[35] = 0.00000060809509960790819604881107807159423828125000000000000000000000000000000000;
a[36] = -0.00000021854383236430408032902050763368606567382812500000000000000000000000000000;
a[37] = 0.00000075138793498297218320658430457115173339843750000000000000000000000000000000;
a[38] = -0.00000057508274009521187508653383702039718627929687500000000000000000000000000000;
a[39] = 0.00000055269872545338216696109157055616378784179687500000000000000000000000000000;
*/
	delta = 0.01;
	for (n=10000; n<1000000; n*=10) {	    
		m = n;
		printf("----------------->>> n = %d, m = %d\n", n, m);
//		delta = 1.0/n;
    		up = (double *) malloc((m + 1) * sizeof(double));
		down = (double *) malloc((m + 1) * sizeof(double));
		maximize();
		free(up);
		free(down);
	}
//	printf("int = %f", integral());
	return 0;
}
